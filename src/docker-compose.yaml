volumes:
  offndat-postgres-data:

services:
  api:
    restart: unless-stopped
    build:
      context: ./
      dockerfile: ./OffndAt.Services.Api/Dockerfile
      args:
        ApplicationSettings__Version: "0.0.0-docker"
    ports:
      - "8090:8080"
    environment:
      OTEL_SERVICE_NAME: "offnd-at-api"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=Production,service.namespace=offnd"
      PersistenceSettings__ConnectionString: "Host=postgres;Username=offndat;Password=offndat;Database=offndat"
      MessageBrokerSettings__Hostname: rabbit-mq
      TelemetrySettings__ExporterEndpoint: "http://otel-collector:4317/"
      AuthSettings__ApiKey: "test-api-key"
    container_name: api
    deploy:
      resources:
        limits:
          memory: 2048M
    depends_on:
      postgres:
        condition: service_healthy
      rabbit-mq:
        condition: service_healthy
      migration-runner:
        condition: service_completed_successfully

  events-worker:
    restart: unless-stopped
    build:
      context: ./
      dockerfile: ./OffndAt.Services.EventsWorker/Dockerfile
      args:
        ApplicationSettings__Version: "0.0.0-docker"
    environment:
      OTEL_SERVICE_NAME: "offnd-at-events-worker"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=Production,service.namespace=offnd"
      PersistenceSettings__ConnectionString: "Host=postgres;Username=offndat;Password=offndat;Database=offndat"
      MessageBrokerSettings__Hostname: rabbit-mq
      TelemetrySettings__ExporterEndpoint: "http://otel-collector:4317/"
    container_name: events-worker
    deploy:
      resources:
        limits:
          memory: 1024M
    depends_on:
      postgres:
        condition: service_healthy
      rabbit-mq:
        condition: service_healthy
      migration-runner:
        condition: service_completed_successfully

  migration-runner:
    restart: on-failure
    build:
      context: ./
      dockerfile: ./OffndAt.Services.MigrationRunner/Dockerfile
    environment:
      OTEL_SERVICE_NAME: "offnd-at-migration-runner"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=Production,service.namespace=offnd"
      PersistenceSettings__ConnectionString: "Host=postgres;Username=offndat;Password=offndat;Database=offndat"
      TelemetrySettings__ExporterEndpoint: "http://otel-collector:4317/"
    container_name: migration-runner
    deploy:
      resources:
        limits:
          memory: 1024M
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:17
    restart: unless-stopped
    environment:
      POSTGRES_USER: offndat
      POSTGRES_PASSWORD: offndat
      POSTGRES_DB: offndat
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U offndat -d offndat" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - offndat-postgres-data:/var/lib/postgresql/data
    container_name: postgres

  rabbit-mq:
    image: rabbitmq:4-management
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q status" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: rabbit-mq

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    restart: unless-stopped
    ports:
      - "4317:4317"
    command: [ "--config", "/etc/otel/config.yaml" ]
    volumes:
      - ./otel-config.yaml:/etc/otel/config.yaml
    env_file:
      - ./.env
    container_name: otel-collector
